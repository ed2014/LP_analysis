---
title: "Analysis of L&P dataset"
output: html_document
---


```{r LoadLibs, echo=FALSE, include=FALSE}
library(xtable)
library(knitr)
library(RSQLite)
library(lubridate)
library(stringr)
library(tidyr)
library(dplyr)
library(ggplot2)
library (hydroGOF)
library(scales)

```


# Load and massage the data

- Tidy up factors/levels (note the need to set new label on csv dataset)

- Separete in Sedling and regrowth phases

- Get data formats right


```{r LoadTidyUp, echo=FALSE,include=FALSE, echo=FALSE}

dataRaw <- read.csv("C:\\GitHubRepos\\LP_analysis\\ObsPre.csv", header = TRUE, skip = 4)

dataWork <- as.data.frame(dataRaw)

dataWork$Date <- as.Date(dmy_hm(dataRaw$Date))

# create new factors from column label
dataWork <- dataWork %>%
  tidyr::gather("ExtraFactors","Predicted",5:112) # FIXME: selected by hand check if valid or make it automated

head(dataWork)

# sort out levels for new fators
dataWork <- dataWork %>%
  separate(ExtraFactors,c("SurfaceKl","RootDepth","KLReduction","RootFrontVelocity"),sep = "_", remove=TRUE)

head(dataWork)

dataWork$SurfaceKl <- as.factor(dataWork$SurfaceKl)
dataWork$RootDepth <- as.factor(dataWork$RootDepth)
dataWork$KLReduction <- as.factor(dataWork$KLReduction)
dataWork$RootFrontVelocity <- as.factor(dataWork$RootFrontVelocity)

# separate into Establishment and regrowth periods (FIXME: find a more functional criteria later)
estDate <- "2012-06-01 00:00:00"
#estDate <- "2012-06-01"

dataWork$Stage <- as.factor(ifelse(dataWork$Date<=estDate,"Establishment","Regrowth"))

# re-order fators (ensure Obs is the LAST one)
dataWork <- dataWork[c("Crop", "Irrigation", "Depth", "Stage","Date",
                       "SurfaceKl", "RootDepth", "KLReduction", "RootFrontVelocity", 
                       "Predicted", "Obs")]

head(dataWork)

colnames(dataWork)[ncol(dataWork)] <- "Observed" # Check if right col #

head(dataWork)

# sort out order of levels
dataWork$SurfaceKl <- factor(dataWork$SurfaceKl, levels = c("Low", "Mid", "Hig"))
dataWork$Depth <-factor(dataWork$Depth, 
                        levels = c("D7","D23", "D30", "D50", "D70", "D90","D110", "D130","D150"))
dataWork$RootDepth <-factor(dataWork$RootDepth, levels = c("500","1000", "2000"))
dataWork$KLReduction <-factor(dataWork$KLReduction, levels = c(".0.0005",".0.001", ".0.002", ".0.005"))
dataWork$RootFrontVelocity <-factor(dataWork$RootFrontVelocity, levels = c("5","15", "30"))
dataWork$Stage <- factor(dataWork$Stage, levels = c("Establishment","Regrowth"))
dataWork$Irrigation <- factor(dataWork$Irrigation, levels = c("None","ThreeWeekly","OnePerWeek","TwoPerWeek"))

# create indexes to call later
dataWork$index_crop <- paste0(dataWork$Crop, "_",
                              dataWork$SurfaceKl, "_",
                              dataWork$RootDepth, "_",
                              dataWork$KLReduction, "_",
                              dataWork$RootFrontVelocity)

dataWork$index_stage <- paste0(dataWork$Crop,"_",
                               dataWork$Stage, "_",
                               dataWork$SurfaceKl, "_",
                               dataWork$RootDepth, "_",
                               dataWork$KLReduction, "_",
                               dataWork$RootFrontVelocity)

dataWork$index_crop <- as.factor(dataWork$index_crop)
dataWork$index_stage <- as.factor(dataWork$index_stage)

```


# Check clean dataset


```{r, echo=FALSE}
# final product
str(dataWork)

head(dataWork, 20)

summary(dataWork)

```

# Create stats function as per Gauch et al paper

```{r CreateStats, echo=FALSE, include=FALSE}


gauchStats <- function(sim, meas) {
  
  n_s <- length(sim)
  n_m <- length(meas)
  model <- lm(meas~sim)
  sim_sq <- sum((sim - mean(sim))^2)
  mes_sq <- sum((meas - mean(meas))^2)
  r2 <- summary(model)$r.squared
  slope <- model$coefficients[[2]]
  
  sb <- (sum(mean(meas)) - sum(mean(sim)))^2
  nu <- (1-slope)^2 * (sim_sq/n_s)
  lc <- (1-r2) * (mes_sq/n_m)
  msd <- sb+nu+lc
  
  sb_r <- round((sb/msd)*100,1)
  nu_r <- round((nu/msd)*100,1)
  lc_r <- round((lc/msd)*100,1)
  
  msd_r <- sb_r+nu_r+lc_r
  
  out <- c(sb_r,nu_r,lc_r, msd_r)
 # out <- c(sb,nu,lc, msd,sim_sq,mes_sq,r2,n_s,n_m,slope ) # testing
  
  return(out)
  
}

# test dataset
s <- c(342.5,	68.3,	70.1,	286.1,	333.8)
m <- c(299.64,	161.36,	201.45,	220.8,	217.67)

gauchStats(s,m)

```

# Calculate table of statistics

```{r DoStatsAll, echo=FALSE, include=FALSE}

# agregate for Crop and Stage
st1 <- dataWork %>%
  dplyr::group_by(Crop, Stage, SurfaceKl, RootDepth, KLReduction, RootFrontVelocity, index_stage) %>%
  dplyr::summarise(
    n = n(),
    r2 = round(br2(Predicted,Observed)*100,0),
    rmse = round(rmse(Predicted,Observed),3),
    r_rmse = round(rmse(Predicted,Observed)/mean(Observed)*100,3),
    nse = round(NSE(Predicted,Observed),1),
    sb = gauchStats(Predicted,Observed)[1],
  nu = gauchStats(Predicted,Observed)[2],
  lc = gauchStats(Predicted,Observed)[3]) 

#statsTable %>%
#  kable(format = "markdown")

head(st1,20)

# re-arrange
#statsTable1 <- st1 %>%
#  tidyr::gather("stats","value",8:15) 

# agregate across crops and stages only
#summary(statsTable1)

# test fit across treatments and depths

# agregate across crops only
st2 <- dataWork %>%
  group_by(Crop, SurfaceKl, RootDepth, KLReduction, RootFrontVelocity, index_crop) %>%
  summarise(
    n = n(),
    r2 = round(br2(Predicted,Observed)*100,0),
    rmse = round(rmse(Predicted,Observed),3),
    r_rmse = round(rmse(Predicted,Observed)/mean(Observed)*100,3),
    nse = round(NSE(Predicted,Observed),1),
    sb = gauchStats(Predicted,Observed)[1],
    nu = gauchStats(Predicted,Observed)[2],
    lc = gauchStats(Predicted,Observed)[3]) 


head(st2,20)

#statsTable2 <- st2 %>%
#  tidyr::gather("stats","value",7:14) 

#summary(statsTable2)


```

# Compare observed and simulated time-series for "dryland"" crops to check

```{r GraphAll, fig.height=18,fig.width=12, echo=FALSE}

# example of dryland crops
dataWork %>%
  filter(Irrigation =="None") %>%
   ggplot() +
  geom_point(aes(x=Date, y=Predicted),colour="grey") +
  geom_point(aes(x=Date, y=Observed, colour="darkred"), size=3) +
  facet_grid(Depth~Crop)


```

# XY graph for Prediced x Observed for whole dataset now

```{r XYgraph , fig.height=18,fig.width=12, echo=FALSE}
dataWork %>%
  ggplot(aes(x=Predicted, y=Observed,colour=factor(Depth))) +
  stat_smooth(method = "lm", se = TRUE, 
              linetype = 3,
              aes(colour=factor(Depth))) +
  geom_point() +
  facet_grid(Crop~Stage, scales ="free") +
  geom_abline(intercept = 0, slope = 1) 


```

# calculates the best fit (lowest r_rmse)

```{r BestFitFinder1, echo=FALSE}

# select lowest r_rmse

# crop + stage
bf1 <- st1  %>% 
  group_by(Crop, Stage) %>%
  filter(r_rmse == min(r_rmse) ) %>%
  filter(lc == max(lc))

rownames(bf1) <- paste0(bf1$Crop,".",bf1$Stage)

t(bf1) %>%
  kable(format = "markdown")

# crop only
bf2 <- st2  %>% 
  group_by(Crop) %>%
  filter(r_rmse == min(r_rmse) )

rownames(bf2) <- paste0(bf2$Crop,".",bf2$Stage)

head(bf2)

t(bf2) %>%
  kable(format = "markdown")

```

# Best fit graphs for LUCERNE

```{r PlotBestFitsLuc, fig.height=18,fig.width=12, echo=FALSE}



# Input best fits here (FIXME: Automate this as a function from paramater estimation)

selecParams <- as.character(unique(bf1$index_stage))

sel1 <- dataWork %>%
  filter(
    # establisment
    index_stage == selecParams[1] | # watch for this conventions of names (FIXME)
    # regrowth phase
    index_stage == selecParams[2]
  ) 

# finds the closest point to the date of establihment
estLoc <- which.min(abs(as.Date(sel1$Date) - as.Date(estDate)))

# graph lucerne
sel1 %>%
  ggplot() +
  geom_point(aes(x=Date, y=Observed), size=2, shape = 1) +
  geom_line(aes(x=Date, y=Predicted),colour="black") +
  facet_grid(Depth~Irrigation, scales = "free") + 
  scale_x_date(labels = date_format("%b")) + scale_shape(solid = FALSE) + 
  geom_vline(xintercept = as.numeric(sel1$Date[estLoc]),linetype = 2)

sel1  %>%
  ggplot(aes(x=Predicted, y=Observed,fill = factor(Stage),colour=factor(Stage))) +
  stat_smooth(method = "lm", se = TRUE, 
            linetype = 3) +
  geom_point() +
  facet_grid(Depth~Irrigation, scales = "free") +
  geom_abline(intercept = 0, slope = 1) 

sel1  %>%
  ggplot(aes(x=Predicted, y=Observed,fill = factor(Depth),colour=factor(Depth))) +
  stat_smooth(method = "lm", se = TRUE, 
            linetype = 3) +
  geom_point() +
  facet_grid(Stage~Irrigation, scales = "free") +
  geom_abline(intercept = 0, slope = 1) 

```

# Best fit graphs for RYEGRASS

```{r BestFitRye, fig.height=18,fig.width=12, echo=FALSE}


# Ryegrass
sel2 <- dataWork %>%
  filter(
    # establisment
    index_stage == selecParams[3] |
    # regrowth phase
    index_stage == selecParams[4]
  ) 


# graph ryegrass
 sel2 %>%
  ggplot() +
  geom_point(aes(x=Date, y=Observed), size=2, shape = 1) +
  geom_line(aes(x=Date, y=Predicted),colour="black") +
  facet_grid(Depth~Irrigation, scales = "free") + 
  scale_x_date(labels = date_format("%b")) + scale_shape(solid = FALSE) + 
  geom_vline(xintercept = as.numeric(sel1$Date[estLoc]),linetype = 2)

sel2  %>%
  ggplot(aes(x=Predicted, y=Observed,fill = factor(Stage),colour=factor(Stage))) +
  stat_smooth(method = "lm", se = TRUE, 
            linetype = 3) +
  geom_point() +
  facet_grid(Depth~Irrigation, scales = "free") +
  geom_abline(intercept = 0, slope = 1) 

sel2  %>%
  ggplot(aes(x=Predicted, y=Observed,fill = factor(Depth),colour=factor(Depth))) +
  stat_smooth(method = "lm", se = TRUE, 
            linetype = 3) +
  geom_point() +
  facet_grid(Stage~Irrigation, scales = "free") +
  geom_abline(intercept = 0, slope = 1)                  



```

# How does the best fit look in terms of RMSE by depth?

```{r StatsPerDepth, echo = FALSE, fig.height=12,fig.width=12, echo=FALSE}

# calculate the stats for the BEST fit
# For each layer and depth combination to show trends
# IDEA: how much this afected water uptake?

sel3 <- rbind(sel1, sel2)


g1 <- sel3 %>%
  dplyr::group_by(Crop, Stage, Irrigation, Depth, SurfaceKl, RootDepth, KLReduction, RootFrontVelocity) %>%
  dplyr::summarise(
    n = n(),
    r2 = round(br2(Predicted,Observed)*100,0),
    rmse = round(rmse(Predicted,Observed),3),
    r_rmse = round(rmse(Predicted,Observed)/mean(Observed)*100,3),
    nse = round(NSE(Predicted,Observed),1),
    sb = gauchStats(Predicted,Observed)[1],
  nu = gauchStats(Predicted,Observed)[2],
  lc = gauchStats(Predicted,Observed)[3]) 

head(g1,20)

# create a factor of  depth as integer
g1$Depth_mm <- as.numeric(gsub("D", "",g1$Depth)) # FIXME: move this to a higher level (earlier) as it can be used in other graphs


g1 %>%
  ggplot(aes(x=Depth_mm*-1, y=r_rmse, colour=factor(Stage))) +
  geom_point() +
  geom_line() +
 # geom_bar(aes(stats='identity')) +
  facet_grid(Crop~Irrigation, scales = "free") +
  coord_flip() + 
 # geom_hline(yintercept = 1,linetype = 20) +
  labs(x = "Soil depth (cm)", y = "Relative Root Mean Squared Error (RMSE, % mean)") +
  theme(text = element_text(size=rel(4))) +
  theme(legend.text=element_text(size=16))



```

