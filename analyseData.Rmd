---
title: "Analysis of L&P dataset"
output: html_document
---


```{r LoadLibs, echo=FALSE, include=FALSE}
library(xtable)
library(knitr)
library(RSQLite)
library(lubridate)
library(stringr)
library(tidyr)
library(dplyr)
library(ggplot2)
library (hydroGOF)
library(scales)

```


## FIXME list

- Print numeric value of Surfacekl in csv output
- Use numeric value of parameters as characters througout to simplify comparisons
- Depth can come as numeric too

## Load and massage the data

- Tidy up factors/levels (note the need to set new label on csv dataset)

- Separete in Sedling and regrowth phases

- Get data formats right


```{r LoadTidyUp, echo=FALSE,include=FALSE, echo=FALSE}

#dataRaw <- read.csv("C:\\GitHubRepos\\LP_analysis\\ObsPre.csv", header = TRUE, skip = 4)
dataRaw <- read.csv("K:\\CPDiary\\Data\\Lucerne & pasture drought trial 2011-2012\\ModelFitting\\ObsPre.csv", header = TRUE)
head(dataRaw)

# Sort out formats
dataWork <- as.data.frame(dataRaw)
dataWork$Date <- as.Date(ymd(dataRaw$Date))

head(dataWork)
summary(dataWork)

# sort out formats
dataWork$KLReduction <- as.numeric(dataWork$KLReduction)
dataWork$RootFrontVelocity <- as.numeric(dataWork$RootFrontVelocity)
dataWork$SurfaceKl <- as.factor(dataWork$SurfaceKl) # FIXME: kl must come as numeric

# Separate into Establishment and Regrowth periods
estDate <- "2012-06-01" # FIXME: find a more functional criteria later #estDate <- "2012-06-01 00:00:00"
dataWork$Stage <- as.factor(ifelse(dataWork$Date<=estDate,"Establishment","Regrowth"))

# colnames(dataWork)[ncol(dataWork)] <- "Obs" # Check if right col # FIXME: Not sure why this was done

# make categories (parameters levels) as factors with numeric values of parameters associated
cat_kl_red <- c("fkl1", "fkl2", "fkl3", "fkl4", "fkl5", "fkl6", "fkl7")
cat_kl_surface <- c("Vlo", "Low", "Mid", "High", "VHig")
cat_depth <- c("D7", "D23", "D30", "D50", "D70", "D90", "D110", "D130", "D150")
# cat_depth <- unique(dataWork$Depth) # FIXME: tricky to reorder - should come as number?
cat_RFV <- c("RFV1", "RFV2", "RFV3")
cat_irr <- c("None","ThreeWeekly","OnePerWeek","TwoPerWeek")

cat_kl_red
cat_kl_surface
cat_depth
cat_RFV
cat_irr

options("scipen"=100, "digits"=4) # prints not in scientific notation

# get numeric values of parameters tested and respective classes
kl_red_cats <- data.frame(KLReduction_cat = cat_kl_red, 
                      #    KLReduction = as.numeric(c(-0.0001,-0.0005,-0.001,-0.002,-0.003,-0.005,-0.01))) 
                           KLReduction =   as.numeric (unique(dataWork$KLReduction)))
kl_surface_cats <- data.frame(SurfaceKl = cat_kl_surface, 
                              SurfaceKl_num = as.numeric(c(0.03, 0.06, 0.09, 0.14, 0.2))) # FIXME: neeed to come as numeric
                           # SurfaceKl =   as.numeric(unique(dataWork$SurfaceKl)))   
depth_cats <- data.frame(Depth = cat_depth, 
                         Depth_num = as.numeric(c(7, 23, 30, 50, 70,90,110,130,150))) # FIXME: neeed to come as numeric
                        # Depth_num = as.numeric(c(7, 23, 30, 50, 70,90,110,130,150)))
RFV_cats <- data.frame(RootFrontVelocity_cat = cat_RFV, 
                      # RootFrontVelocity = as.numeric(c(5,15,30)))
                       RootFrontVelocity = as.numeric(unique(dataWork$RootFrontVelocity)))


kl_red_cats
kl_surface_cats
depth_cats
RFV_cats

# add cats or numeric values accordingly to tidy up
dataWork <- merge(dataWork,kl_red_cats,by="KLReduction")
dataWork <- merge(dataWork,kl_surface_cats,by="SurfaceKl")
dataWork <- merge(dataWork,depth_cats,by="Depth")
dataWork <- merge(dataWork,RFV_cats,by="RootFrontVelocity")

head(dataWork)


# sort out new var formats
dataWork$KLReduction_cat <- as.factor(dataWork$KLReduction_cat)
dataWork$SurfaceKl_num <- as.numeric(dataWork$SurfaceKl_num)
dataWork$Depth_num <- as.numeric(dataWork$Depth_num)
dataWork$RootFrontVelocity_cat <- as.factor(dataWork$RootFrontVelocity_cat)

head(dataWork)

summary(dataWork)

# re-order factor levels of factors as categories
dataWork$SurfaceKl <- factor(dataWork$SurfaceKl, levels = cat_kl_surface)
dataWork$Depth <- factor(dataWork$Depth, levels = cat_depth)
dataWork$KLReduction_cat <- factor(dataWork$KLReduction_cat, levels = cat_kl_red)
dataWork$RootFrontVelocity_cat <- factor(dataWork$RootFrontVelocity_cat, levels = cat_RFV)
dataWork$Stage <- factor(dataWork$Stage, levels = c("Establishment","Regrowth"))
dataWork$Irrigation <- factor(dataWork$Irrigation, levels = cat_irr)

# create indexes to call later
dataWork$index <- paste0(dataWork$Crop, "_",
                         dataWork$Stage, "_",
                              dataWork$SurfaceKl, "_",
                              dataWork$KLReduction_cat, "_",
                              dataWork$RootFrontVelocity_cat)

dataWork$index <- as.factor(dataWork$index)

# pooled by crop (excludes stage)
dataWork$index_crop <- paste0(dataWork$Crop,"_",
                              dataWork$SurfaceKl, "_",
                              dataWork$KLReduction_cat, "_",
                              dataWork$RootFrontVelocity_cat)

dataWork$index_crop <- as.factor(dataWork$index_crop)

# re-order fators (ensure Obs is the LAST one)
dataWork <- dataWork[c("Crop", "Irrigation",            
                       "Depth",
                       "Depth_num",
                       "Stage",
                       "Date",
                       "SurfaceKl", 
                       "SurfaceKl_num",
                       "KLReduction_cat",
                       "KLReduction", 
                       "RootFrontVelocity_cat",
                       "RootFrontVelocity", 
                       "index",
                       "index_crop",
                       "Pred", "Obs")]

```


## Check clean dataset


```{r, echo=FALSE}
# final product
str(dataWork)
head(dataWork, 20)
summary(dataWork)

```


## Compare Obs and simulated time-series 

- For "dryland"" crops just to check
- All simulated values (grey) and observed values (red)

```{r GraphExample, fig.height=18,fig.width=12, echo=FALSE}

# example of dryland crops
dataWork %>%
  filter(Irrigation =="None") %>%
  ggplot() +
  geom_point(aes(x=Date, y=Pred),colour="grey") +
  geom_point(aes(x=Date, y=Obs), size=2, colour="darkred") +
  facet_grid(Depth~Crop)

```

## XY graph for Prediced x Obs for whole dataset now

```{r XYgraph , fig.height=18,fig.width=12, echo=FALSE}
dataWork %>%
  ggplot(aes(x=Pred, y=Obs,colour=factor(Depth))) +
  stat_smooth(method = "lm", se = TRUE, 
              linetype = 3,
              aes(colour=factor(Depth))) +
  geom_point() +
  facet_grid(Crop~Stage, scales ="free") +
  geom_abline(intercept = 0, slope = 1) 

```


```{r CreateStats, echo=FALSE, include=FALSE}

# Create stats function as per Gauch et al paper

gauchStats <- function(sim, meas) {
  
  n_s <- length(sim)
  n_m <- length(meas)
  model <- lm(meas~sim)
  sim_sq <- sum((sim - mean(sim))^2)
  mes_sq <- sum((meas - mean(meas))^2)
  r2 <- summary(model)$r.squared
  slope <- model$coefficients[[2]]
  
  sb <- (sum(mean(meas)) - sum(mean(sim)))^2
  nu <- (1-slope)^2 * (sim_sq/n_s)
  lc <- (1-r2) * (mes_sq/n_m)
  msd <- sb+nu+lc
  
  sb_r <- round((sb/msd)*100,1)
  nu_r <- round((nu/msd)*100,1)
  lc_r <- round((lc/msd)*100,1)
  
  msd_r <- sb_r+nu_r+lc_r
  
  out <- c(sb_r,nu_r,lc_r, msd_r)
 # out <- c(sb,nu,lc, msd,sim_sq,mes_sq,r2,n_s,n_m,slope ) # testing
  
  return(out)
  
}


# overall stats function including gauch FIXME: Not working
statsFunc <- function (sim, meas){
    n = n()
    r2 = br2(sim,meas)*100
    rmse = rmse(sim,meas)
    r_rmse = rmse(sim,Obs)/mean(meas)*100 # big precision to enable cretrial of selection 
    nse = NSE(sim,meas)
    sb = gauchStats(sim,meas)[1]
    nu = gauchStats(sim,meas)[2]
    lc = gauchStats(sim,meas)[3]
    
    out <- c(n, r2, rmse, r_rmse, nse, sb, nu, lc)
    
    return(out)
} 

dataWork %>%
  group_by(Crop, SurfaceKl, KLReduction_cat, RootFrontVelocity_cat, index, index_crop) %>%
  summarise(
    n = n(),
    r2 = br2(Pred,Obs)*100,
    rmse = rmse(Pred,Obs),
    r_rmse = rmse(Pred,Obs)/mean(Obs)*100, # big precision to enable cretrial of selection 
    nse = NSE(Pred,Obs),
    sb = gauchStats(Pred,Obs)[1],
    nu = gauchStats(Pred,Obs)[2],
    lc = gauchStats(Pred,Obs)[3]) 


# test dataset
s <- c(342.5,	68.3,	70.1,	286.1,	333.8)
m <- c(299.64,	161.36,	201.45,	220.8,	217.67)

gauchStats(s,m)

```

## Calculate table of statistics


```{r DoStatsAll, echo=FALSE, include=FALSE}

# Pooled by Crop only - agregate and do stats across crops only
st1 <- dataWork %>%
  group_by(Crop, SurfaceKl_num, KLReduction_cat, RootFrontVelocity_cat, index_crop) %>%
  summarise(
    n = n(),
    r2 = round(br2(Pred,Obs)*100,0),
    rmse = round(rmse(Pred,Obs),3),
    r_rmse = rmse(Pred,Obs)/mean(Obs)*100, # big precision to enable cretrial of selection 
    nse = round(NSE(Pred,Obs),1),
    sb = gauchStats(Pred,Obs)[1],
    nu = gauchStats(Pred,Obs)[2],
    lc = gauchStats(Pred,Obs)[3]) 

head(st1,20)

# Pooled by Crop & Stage - Agregate all layers (i.e. remove Depth from grouping) and do stats for Crop and Stage
st2 <- dataWork %>%
  dplyr::group_by(Crop, Stage, SurfaceKl, KLReduction_cat, RootFrontVelocity_cat, index) %>%
  dplyr::summarise(
    n = n(),
    r2 = round(br2(Pred,Obs)*100,0),
    rmse = round(rmse(Pred,Obs),3), # FIXME: what to do when there are similar rmse for different parameters?
    r_rmse = rmse(Pred,Obs)/mean(Obs)*100,
    nse = round(NSE(Pred,Obs),2),
    sb = gauchStats(Pred,Obs)[1],
  nu = gauchStats(Pred,Obs)[2],
  lc = gauchStats(Pred,Obs)[3]) 

head(st2,20)

# Stats per layer
# Test version - not used
# TODO: Do stats by soil depth and drop similations that have poor fit on top layers OR ...

st3 <- dataWork %>%
  dplyr::group_by(Crop, Stage, Depth, SurfaceKl, KLReduction_cat, RootFrontVelocity_cat, index) %>%
  dplyr::summarise(
    n = n(),
    r2 = br2(Pred,Obs)*100,
    rmse = rmse(Pred,Obs), # FIXME: what to do when there are similar rmse for different parameters?
    r_rmse = rmse(Pred,Obs)/mean(Obs)*100,
    nse = NSE(Pred,Obs),
    sb = gauchStats(Pred,Obs)[1],
  nu = gauchStats(Pred,Obs)[2],
  lc = gauchStats(Pred,Obs)[3]) 

head(st3,20)

# weights per layer
weightsPerLayer <- c(2,1,1,1,1,1,1,1,1)

# STOPPED here need to change values of st1 and st2 that where inverted
# Also need to get caegories numbers sorted

```



```{r AnalyseStats, fig.height=18,fig.width=12, echo=FALSE}


# how are statistics related
# is there any relationship between r_rmse and lc
st1 %>%
  tidyr::gather("Stats", "Value", 10:14) %>%
  ggplot(aes(x=rmse, y=Value, colour=factor(Crop))) +
  geom_point () +
  geom_smooth() + 
  facet_grid(Stats~Crop, scales = "free")

# IDEA: the best combination of low rmse and high lc




st1  %>% 
  ungroup() %>% # to allow mutate
  group_by(Crop, Stage) %>%
  ggplot(aes(x = SurfaceKl, 
             y = KLReduction_cat, 
             z = RootFrontVelocity_cat, 
             fill = r_rmse)) +
  geom_tile() + 
  coord_equal() +
  stat_contour() + 
  facet_grid(Stage~Crop+RootFrontVelocity_cat) + 
    scale_colour_gradientn(colours=rainbow(4)) +
  xlab("Surface kl category") +
  ylab("Exponential kl reduction category")+
  theme(text = element_text(size=16))



# add continuous value sof factor (parameters)
st2 <- merge(st1,kl_red_cats,by="KLReduction_cat")
st2 <- merge(st1,kl_surface_cats,by="SurfaceKl")
st2 <- merge(st1,RFV_cats,by="RootFrontVelocity_cat")

# sensiti plots for lc and rmse
st2 %>%
  ungroup() %>% # to allow mutate
  mutate(RootFrontVelocity_cat = 
           factor(RootFrontVelocity_cat,levels = c("Low", "Mid", "High"))) %>%
  ggplot(aes(x=lc, colour=factor(SurfaceKl),fill=factor(SurfaceKl))) +
  geom_density(alpha=0.2) + 
  facet_grid(Stage~Crop)

head(st2)



```



## calculates the best fit (lowest r_rmse)

```{r BestFitFinder1, echo=FALSE}

# select lowest r_rmse

# finds best fit for the establishment phase first
bf0 <- st1  %>% 
  filter(Stage=="Establishment") %>%
  group_by(Crop) %>%
  filter(r_rmse == min(r_rmse) ) %>%
  filter(lc == max(lc)) #%>%
 # filter(r_rmse == min(r_rmse) ) 

rownames(bf0) <- paste0(bf0$Crop)

t(bf0) %>%
  kable(format = "markdown")

selecParamsEst <- as.character(unique(bf0$index))
RVF_luc_est <- bf0[bf0$Crop=="Lucerne",]$RootFrontVelocity_cat
RVF_rye_est <- bf0[bf0$Crop=="Pasture",]$RootFrontVelocity_cat

# now select best fit for regrowth by setting the RFV to the selected in the establishment phase
bf1 <- st1  %>% 
  filter(  
    index == selecParamsEst[1] | # bring back only selected establishmnet combinations 
    index == selecParamsEst[2] |
    (Crop == "Lucerne" &  Stage == "Regrowth" & RootFrontVelocity_cat == RVF_luc_est) |   
    (Crop == "Pasture" &  Stage == "Regrowth" & RootFrontVelocity_cat == RVF_rye_est)
    ) %>% 
  group_by(Crop, Stage) %>%
  filter(r_rmse == min(r_rmse) ) %>%
  filter(lc == max(lc))

rownames(bf1) <- paste0(bf1$Crop,".",bf1$Stage)

t(bf1) %>%
  kable(format = "markdown")


```

## Best fit graphs for LUCERNE

```{r PlotBestFitsLuc, fig.height=18,fig.width=12, echo=FALSE}



# Input best fits here (FIXME: Automate this as a function from paramater estimation)

selecParams <- as.character(unique(bf1$index))

sel1 <- dataWork %>%
  filter(
    # establisment
    index == selecParams[1] | # watch for this conventions of names (FIXME)
    # regrowth phase
    index == selecParams[2]
  ) 

# finds the closest point to the date of establihment
estLoc <- which.min(abs(as.Date(sel1$Date) - as.Date(estDate)))

# graph lucerne
sel1 %>%
  ggplot() +
  geom_point(aes(x=Date, y=Obs), size=2, shape = 1) +
  geom_line(aes(x=Date, y=Pred),colour="black") +
  facet_grid(Depth~Irrigation, scales = "free") + 
  scale_x_date(labels = date_format("%b")) + scale_shape(solid = FALSE) + 
  geom_vline(xintercept = as.numeric(sel1$Date[estLoc]),linetype = 2) +
  ylab("Volumetric soil moisture (mm)") +
  theme(text = element_text(size=16))

#sel1  %>%
#  ggplot(aes(x=Pred, y=Obs,fill = factor(Stage),colour=factor(Stage))) +
#  stat_smooth(method = "lm", se = TRUE, 
#            linetype = 3) +
#  geom_point() +
#  facet_grid(Depth~Irrigation, scales = "free") +
#  geom_abline(intercept = 0, slope = 1) 

sel1  %>%
  ggplot(aes(x=Pred, y=Obs,fill = factor(Depth),colour=factor(Depth))) +
  stat_smooth(method = "lm", se = TRUE, 
            linetype = 3) +
  geom_point() +
  facet_grid(Stage~Irrigation, scales = "free") +
  geom_abline(intercept = 0, slope = 1) 

```

## Best fit graphs for RYEGRASS

```{r BestFitRye, fig.height=18,fig.width=12, echo=FALSE}


# Ryegrass
sel2 <- dataWork %>%
  filter(
    # establisment
    index == selecParams[3] |
    # regrowth phase
    index == selecParams[4]
  ) 


# graph ryegrass
 sel2 %>%
  ggplot() +
  geom_point(aes(x=Date, y=Obs), size=2, shape = 1) +
  geom_line(aes(x=Date, y=Pred),colour="black") +
  facet_grid(Depth~Irrigation, scales = "free") + 
  scale_x_date(labels = date_format("%b")) + scale_shape(solid = FALSE) + 
  geom_vline(xintercept = as.numeric(sel1$Date[estLoc]),linetype = 2)+
  ylab("Volumetric soil moisture (mm)") +
  theme(text = element_text(size=16))

#sel2  %>%
#  ggplot(aes(x=Pred, y=Obs,fill = factor(Stage),colour=factor(Stage))) +
#  stat_smooth(method = "lm", se = TRUE, 
#            linetype = 3) +
#  geom_point() +
#  facet_grid(Depth~Irrigation, scales = "free") +
#  geom_abline(intercept = 0, slope = 1) 

sel2  %>%
  ggplot(aes(x=Pred, y=Obs,fill = factor(Depth),colour=factor(Depth))) +
  stat_smooth(method = "lm", se = TRUE, 
            linetype = 3) +
  geom_point() +
  facet_grid(Stage~Irrigation, scales = "free") +
  geom_abline(intercept = 0, slope = 1)                  



```

## How does the best fit(s) look for RMSE by depth?

```{r RmsdPerDepth, echo = FALSE, fig.height=12,fig.width=12, echo=FALSE}

# calculate the stats for the BEST fit
# For each layer and depth combination to show trends
# IDEA: how much this afected water uptake?

sel3 <- rbind(sel1, sel2)

# calculates stats by depth
g1 <- sel3 %>%
  dplyr::group_by(Crop, Stage, Irrigation, Depth, Depth_num, SurfaceKl, KLReduction, RootFrontVelocity) %>%
  dplyr::summarise(
    n = n(),
    r2 = round(br2(Pred,Obs)*100,0),
    rmse = round(rmse(Pred,Obs),3),
    r_rmse = round(rmse(Pred,Obs)/mean(Obs)*100,3),
    nse = round(NSE(Pred,Obs),1),
    sb = gauchStats(Pred,Obs)[1],
  nu = gauchStats(Pred,Obs)[2],
  lc = gauchStats(Pred,Obs)[3]) 

head(g1,20)

# create a factor of  depth as integer
#g1$Depth_num <- as.numeric(gsub("D", "",g1$Depth)) # FIXME: move this to a higher level (earlier) as it can be used in other graphs

# _rmse by depth and crop
g1 %>%
  ggplot(aes(x=Depth_num*-1, y=r_rmse, colour=factor(Stage))) +
  geom_point() +
  geom_line() +
 # geom_bar(aes(stats='identity')) +
  facet_grid(Crop~Irrigation) +
  coord_flip() + 
  geom_hline(yintercept = 20,linetype = 20) +
  labs(x = "Soil depth (cm)", y = "Relative Root Mean Squared Error (RMSE, % mean)") +
  theme(text = element_text(size=rel(4))) +
  theme(legend.text=element_text(size=16))




```


## Bring all stats together

- Compare stats across depths now

```{r StatsPerDepth, echo = FALSE, fig.height=12,fig.width=12, echo=FALSE}
# bring all stats together

# lucerne
g1 %>%
  dplyr::select(-sb,-nu,-lc,-n) %>%
  tidyr::gather("StatsType","StatsValue", 9:12) %>%
  filter(Crop == "Lucerne") %>%
  ggplot(aes(x=Depth_num, y=StatsValue, colour=factor(Stage))) +
  geom_point() +
  geom_line() +
 # geom_bar(aes(stats='identity')) +
  facet_wrap(~StatsType+Irrigation,scales = "free", ncol=4) +
 # coord_flip() + 
  labs(x = "Soil depth (cm)", y = "Stats (xxxxx)") +
  theme(text = element_text(size=rel(4))) +
  theme(legend.text=element_text(size=16))


# pasture
g1 %>%
  dplyr::select(-sb,-nu,-lc,-n) %>%
  tidyr::gather("StatsType","StatsValue", 9:12) %>%
  filter(Crop == "Pasture") %>%
  ggplot(aes(x=Depth_num, y=StatsValue, colour=factor(Stage))) +
  geom_point() +
  geom_line() +
  facet_wrap(~StatsType~Irrigation, scales = "free") +
#  coord_flip() + 
  labs(x = "Soil depth (cm)", y = "Stats (xxxxxx)") +
  theme(text = element_text(size=rel(4))) +
  theme(legend.text=element_text(size=16))
```



## Partition of RMSE into Gauch fractions

- Standard bias (SB)

- Non Unit (NU)

- Lack of Correlation (LU)

```{r GauchStatsByDepth, echo = TRUE, fig.height=12,fig.width=12, echo=FALSE}

df <- g1 %>%
  mutate(sb=sb*rmse, nu=nu*rmse, lc=lc*rmse) %>%
 # dplyr::select(-n, -r2,-rmse,-r_rmse,-nse) %>%
  dplyr::select(-n, -r2,-r_rmse,-nse) %>%
  tidyr::gather("StatsType","StatsValue", 10:12) # %>%
  # mutate(Depth = factor(Depth, rev(cat_depth)))

# graph
  df %>%
#  filter(Crop == "Lucerne") %>%
  ggplot(aes(x=Depth, y=StatsValue*rmse,fill=StatsType)) +
  geom_bar(stat='identity') +
  facet_grid(Stage+Crop~Irrigation,scales = "free") +
  coord_flip() + 
  labs(x = "Soil depth category", y = "RMSE (fractional)") +
  theme(text = element_text(size=rel(4))) +
  theme(legend.text=element_text(size=16))

```


